name: Deploy to UAT

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.UAT_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p 2011 ${{ secrets.UAT_SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to UAT Server
        run: |
          ssh -p 2011 \
              -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.UAT_SSH_USER }}@${{ secrets.UAT_SSH_HOST }} << 'EOF'
            set -e
            
            echo "üì¶ Navigating to project directory..."
            cd /home/pdharamkar/TimeharborApp
            
            echo "üîÑ Pulling latest code from main..."
            git pull origin main
            
            echo "üõë Stopping PM2 services..."
            sudo pm2 stop ecosystem.config.js || true
            
            echo "‚öôÔ∏è  Installing dependencies for express-api..."
            cd express-api
            sudo npm install
            
            echo "üèóÔ∏è  Building TypeScript backend..."
            sudo npm run build
            
            echo "üóÉÔ∏è  Checking for database migrations..."
            PENDING_MIGRATIONS=$(sudo npx sequelize-cli db:migrate:status 2>&1 | grep -c "pending" || true)
            if [ "$PENDING_MIGRATIONS" -gt 0 ]; then
              echo "üìä Running $PENDING_MIGRATIONS pending migration(s)..."
              sudo npx sequelize-cli db:migrate
            else
              echo "‚úÖ No pending migrations, database is up to date"
            fi
            cd ..
            
            echo "‚öôÔ∏è  Installing dependencies for timeharbor-proxy..."
            cd timeharbor-proxy
            sudo npm install --production
            cd ..
            
            echo "‚öôÔ∏è  Installing dependencies for timeharbourapp..."
            cd timeharbourapp
            sudo npm install
            
            echo "üèóÔ∏è  Building Next.js frontend..."
            sudo npm run build
            cd ..
            
            echo "ÔøΩ Starting PM2 services..."
            sudo pm2 start ecosystem.config.js --update-env
            
            echo "‚úÖ Deployment completed successfully!"
            sudo pm2 status
          EOF

      - name: Deployment Status
        if: success()
        run: echo "‚úÖ Successfully deployed to UAT!"

      - name: Deployment Failed
        if: failure()
        run: echo "‚ùå Deployment failed! Check the logs above."
